<!DOCTYPE html>
<html lang="en">
<head>
    <title>Swimmers</title>
    <!-- Load jQuery from CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
</head>
<body>
    <h1>Swimmers GALA records</h1>
    
    <!-- Button to show the create form -->
    <button id="showCreateButton" onclick="showCreate()">Add Swimmer</button>

    <!-- Swimmers table -->
    <table border="2" class="table" id="swimmerTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Sex</th>
                <th>Age Group</th>
                <th>Event</th>
                <th>Date</th>
                <th>Time</th>
                <th>Update</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody id="swimmerBody"></tbody>  
    </table>
    
    <!-- Create/Update swimmer form (hidden by default) -->
    <div id="createUpdateForm" style="display:none">
        <h3>
            <span id="createLabel">Create</span>
            <span id="updateLabel" style="display:none">Update</span> Swimmer
        </h3>
        <input type="hidden" name="id"/>
        First Name: <input type="text" name="first_name"><br/>
        Last Name: <input type="text" name="last_name"><br/>
        Sex: <input type="text" name="sex"><br/>
        Age Group: <input type="number" name="age_group"><br/>
        Event: <input type="text" name="event"><br/>
        Date: <input type="date" name="date"><br/>
        Time: <input type="text" name="time" placeholder="MM:SS:ss"><br/>  
        
        <button id="doCreateButton" onclick="doCreate()">Create</button>
        <button id="doUpdateButton" onclick="doUpdate()" style="display:none">Update</button>
    </div>

    <script>
        // Validate time format (MM:SS:ss)
        function isValidTimeFormat(timeStr) {
            return /^\d{2}:\d{2}:\d{2}$/.test(timeStr);
        }

        // Show the create form
        function showCreate() {
            document.getElementById("createUpdateForm").style.display = "block";
            document.getElementById("showCreateButton").style.display = "none";
        }

        // Create swimmer using form input and send to server
        function doCreate() {
            const form = document.getElementById("createUpdateForm");

            const swimmer = {
                first_name: form.querySelector('input[name="first_name"]').value,
                last_name: form.querySelector('input[name="last_name"]').value,
                sex: form.querySelector('input[name="sex"]').value,
                age_group: form.querySelector('input[name="age_group"]').value,
                event: form.querySelector('input[name="event"]').value,
                date: form.querySelector('input[name="date"]').value,
                time: form.querySelector('input[name="time"]').value
            };

            // Check time format
            if (!isValidTimeFormat(swimmer.time)) {
                alert("Please enter time in MM:SS:ss format (e.g., 02:45:37)");
                return;
            }

            // POST to /results
            $.ajax({
                url: "/results",
                method: "POST",
                data: JSON.stringify(swimmer),
                contentType: "application/json",
                dataType: "json",
                success: function (result) {
                    // reload all swimmers
                    document.getElementById("swimmerBody").innerHTML="";
                    getAllswimmers(); //reload updated data
                    alert("Swimmer added");

                    // reset form
                    form.reset();
                    document.getElementById("createUpdateForm").style.display = "none";
                    document.getElementById("showCreateButton").style.display = "block";
                },
                error: function (xhr, status, error) {
                    alert("Failed to create swimmer: " + error);
                    console.log(xhr.responseText);
                }
            });
        }

        // Load all swimmers from the server on page load
        function getAllswimmers() {
            $.ajax({
                url: "/results",
                method: "GET",
                dataType: "json",
                success: function (data) {
                    for (let swimmer of data) {
                        addSwimmerToTable(swimmer);
                    }
                },
                error: function (xhr, status, error) {
                    alert("Failed to load swimmers: " + error);
                }
            });
        }

        // Add one swimmer to the HTML table
        function addSwimmerToTable(swimmer) {
            const table = document.getElementById("swimmerBody");
            const row = document.createElement("tr");
            row.setAttribute("id", "row-" + swimmer.id);

            row.innerHTML = `
                <td>${swimmer.id}</td>
                <td>${swimmer.first_name}</td>
                <td>${swimmer.last_name}</td>
                <td>${swimmer.sex}</td>
                <td>${swimmer.age_group}</td>
                <td>${swimmer.event}</td>
                <td>${swimmer.date}</td>
                <td>${swimmer.time}</td>
                <td><button onclick="showUpdate(${swimmer.id})">Update</button></td>
                <td><button onclick="doDelete(${swimmer.id})">Delete</button></td>
            `;

            table.appendChild(row);
        }

        // Placeholder update logic
        function showUpdate(id) {
            alert("Update swimmer ID: " + id);
        }

        // Delete swimmer by ID
        function doDelete(id) {
            if (!confirm("Do you want to delete swimmer ID: " + id + "?")) return;

            $.ajax({
                url: `/results/${id}`,
                method: "DELETE",
                success: function () {
                    const row = document.getElementById("row-" + id);
                    if (row) row.remove();
                },
                error: function (xhr, status, error) {
                    alert("Failed to delete swimmer: " + error);
                }
            });
        }

        // Get all
        getAllswimmers();
    </script>
</body>
</html>
